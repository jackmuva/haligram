(()=>{var e={};e.id=543,e.ids=[543],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1820:e=>{"use strict";e.exports=require("os")},1970:(e,r,t)=>{"use strict";t.a(e,async(e,s)=>{try{t.d(r,{Me:()=>f,UK:()=>m,pD:()=>p,tR:()=>h,wz:()=>d}),t(5710);var a=t(5817),n=t(8855),o=t(7671),i=t(4634),u=e([n,a]);[n,a]=u.then?(await u)():u;let c=(0,a.f)((0,n.createClient)({url:process.env.TURSO_DATABASE_URL,authToken:process.env.TURSO_AUTH_TOKEN??""})),l=async(e,r)=>{try{return c.insert(o.kQ).values({email:e,name:r}).returning()}catch(e){throw console.error("unable to create user",e),e}},d=async(e,r)=>{try{let t=await c.select().from(o.kQ).where((0,i.eq)(o.kQ.email,e));return 0===t.length&&(t=await l(e,r)),t}catch(e){throw console.error("Failed to get user by email",e),e}},p=async e=>{try{let r=await c.select().from(o.kQ).where((0,i.eq)(o.kQ.email,e));if(0===r.length)return console.error("no token for user"),[];return await c.select().from(o.aP).where((0,i.eq)(o.aP.userId,r[0].id))}catch(e){throw console.error("Failed to get reddit token by email",e),e}},h=async(e,r,t)=>{try{let s=await c.select().from(o.kQ).where((0,i.eq)(o.kQ.email,e));if(0===s.length)return console.error("no token for user"),[];let a=await p(e);if(0===a.length)return await c.insert(o.aP).values({userId:s[0].id,accessToken:r,refreshToken:t}).returning();return await c.update(o.aP).set({accessToken:r,refreshToken:t,updatedAt:new Date().toUTCString()}).where((0,i.eq)(o.aP.userId,s[0].id)).returning()}catch(e){throw console.error("Failed to upsert reddit token",e),e}},m=async e=>{try{let r=await c.select().from(o.kQ).where((0,i.eq)(o.kQ.email,e));if(0===r.length)return console.error("no token for user"),[];return await c.select().from(o.fX).where((0,i.eq)(o.fX.userId,r[0].id))}catch(e){throw console.error("failed to get reddit searches",e),e}},f=async(e,r)=>{try{let t=await c.select().from(o.kQ).where((0,i.eq)(o.kQ.email,e));if(0===t.length)return console.error("no token for user"),[];let s=await m(e);if(0===s.length)return await c.insert(o.fX).values({userId:t[0].id,searches:{terms:[r]}}).returning();{let e=s[0].searches.terms;return e.unshift(r),e.length>10&&e.pop(),await c.update(o.fX).set({searches:{terms:e}}).where((0,i.eq)(o.fX.userId,t[0].id)).returning()}}catch(e){throw console.error("Failed to upsert reddit search",e),e}};s()}catch(e){s(e)}})},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3573:(e,r,t)=>{"use strict";t.d(r,{CI:()=>u,Jv:()=>i,Y9:()=>n,j2:()=>o});var s=t(8643),a=t(3560);t(2175);let{handlers:n,auth:o,signIn:i,signOut:u}=(0,s.Ay)({providers:[a.A]})},3841:(e,r,t)=>{"use strict";t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{POST:()=>i});var a=t(3573),n=t(1970),o=e([n]);async function i(){let e=await (0,a.j2)();if(!e||!e.user)return Response.json({status:400,message:"user has not authenticated"});if(!e.user.name||!e.user.email)return Response.json({status:500,message:"problem getting session"});let r=await (0,n.wz)(e.user.email,e.user.name);return Response.json({user:r[0]})}n=(o.then?(await o)():o)[0],s()}catch(e){s(e)}})},3873:e=>{"use strict";e.exports=require("path")},4797:(e,r,t)=>{"use strict";t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{patchFetch:()=>c,routeModule:()=>l,serverHooks:()=>h,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>p});var a=t(6559),n=t(8088),o=t(7719),i=t(3841),u=e([i]);i=(u.then?(await u)():u)[0];let l=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/(auth)/api/user/route",pathname:"/api/user",filename:"route",bundlePath:"app/(auth)/api/user/route"},resolvedPagePath:"/Users/jackmu/Documents/haligram/src/app/(auth)/api/user/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:d,workUnitAsyncStorage:p,serverHooks:h}=l;function c(){return(0,o.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:p})}s()}catch(e){s(e)}})},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5229:(e,r,t)=>{Promise.resolve().then(t.bind(t,2175))},5511:e=>{"use strict";e.exports=require("crypto")},6669:(e,r,t)=>{Promise.resolve().then(t.bind(t,9208))},7671:(e,r,t)=>{"use strict";t.d(r,{aP:()=>i,fX:()=>u,kQ:()=>o});var s=t(5511),a=t(3809),n=t(9283);let o=(0,a.D)("users",{id:(0,n.Qq)("id").primaryKey().$defaultFn(()=>(0,s.randomUUID)()),name:(0,n.Qq)("name").notNull(),email:(0,n.Qq)("email").notNull().unique()}),i=(0,a.D)("RedditTokens",{id:(0,n.Qq)("id").primaryKey().$defaultFn(()=>(0,s.randomUUID)()),userId:(0,n.Qq)("userId").references(()=>o.id).notNull(),accessToken:(0,n.Qq)("accessToken").notNull(),refreshToken:(0,n.Qq)("refreshToken").notNull(),updatedAt:(0,n.Qq)("updatedAt").$defaultFn(()=>new Date().toUTCString())}),u=(0,a.D)("RedditSearch",{id:(0,n.Qq)("id").primaryKey().$defaultFn(()=>(0,s.randomUUID)()),userId:(0,n.Qq)("userId").references(()=>o.id).notNull(),searches:(0,n.Qq)("searches",{mode:"json"}).$type()})},8855:e=>{"use strict";e.exports=import("@libsql/client")},9021:e=>{"use strict";e.exports=require("fs")},9121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[447,190,193,668],()=>t(4797));module.exports=s})();